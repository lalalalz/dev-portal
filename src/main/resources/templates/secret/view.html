<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인프라 시크릿 생성기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
        }

        .container {
            max-width: 900px;
        }

        .header {
            background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            margin-bottom: 2rem;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e3e6f0;
            font-weight: 700;
            padding: 1rem 1.25rem;
        }

        .form-check-input:checked {
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }

        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }

        .json-output {
            background-color: #f8f9fa;
            border-radius: 0.35rem;
            font-family: monospace;
            padding: 1rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .copy-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }

        .hidden {
            display: none;
        }

        #loading {
            display: none;
            margin: 20px auto;
        }

        .infrastructure-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .infra-card {
            border: 1px solid #e3e6f0;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .infra-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        .infra-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            z-index: 1000;
            transition: opacity 0.5s;
            opacity: 0;
        }
    </style>
</head>
<body>
<div class="header text-center">
    <h1>인프라 시크릿 생성기</h1>
    <p class="lead">애플리케이션 인프라스트럭처 설정을 쉽게 생성하세요</p>
</div>

<div class="container py-4">
    <div class="notification" id="copyNotification">클립보드에 복사되었습니다!</div>

    <!-- 탭 네비게이션 추가 -->
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane"
                    type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true">시크릿 생성
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-tab-pane"
                    type="button" role="tab" aria-controls="search-tab-pane" aria-selected="false">시크릿 조회
            </button>
        </li>
    </ul>

    <!-- 탭 콘텐츠 -->
    <div class="tab-content" id="myTabContent">
        <!-- 시크릿 생성 탭 -->
        <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab"
             tabindex="0">
            <div class="card">
                <div class="card-header">
                    새 애플리케이션 등록
                </div>
                <div class="card-body">
                    <form id="infraForm">
                        <div class="mb-3">
                            <label for="environment" class="form-label">환경 프로필</label>
                            <select class="form-select" id="environment" name="environment" required>
                                <option value="" selected disabled>환경을 선택하세요</option>
                                <option value="DEV" selected>개발 환경 (DEV)</option>
                                <!--                                <option value="PROD">운영 환경 (PROD)</option>-->
                            </select>
                            <div class="form-text">시크릿을 생성할 환경 프로필을 선택하세요.</div>
                        </div>

                        <div class="mb-3">
                            <label for="applicationName" class="form-label">서비스 이름</label>
                            <input type="text" class="form-control" id="applicationName" name="service" required
                                   placeholder="예: TEST, PAYMENT">
                            <div class="form-text">조회할 서비스의 이름을 입력하세요. 영문, 숫자, 하이픈만 사용 가능합니다.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">사용할 인프라스트럭처 선택</label>
                            <div class="infrastructure-options">
                                <div class="infra-card">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="MYSQL"
                                               id="mysqlCheck" name="infrastructures">
                                        <label class="form-check-label" for="mysqlCheck">
                                            <div class="infra-icon text-primary">
                                                <i class="bi bi-database"></i>
                                            </div>
                                            <h5>MySQL</h5>
                                            <small>관계형 데이터베이스</small>
                                        </label>
                                    </div>
                                </div>

                                <div class="infra-card">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="MONGO"
                                               id="mongodbCheck" name="infrastructures">
                                        <label class="form-check-label" for="mongodbCheck">
                                            <div class="infra-icon text-success">
                                                <i class="bi bi-hdd"></i>
                                            </div>
                                            <h5>MongoDB</h5>
                                            <small>문서 기반 NoSQL DB</small>
                                        </label>
                                    </div>
                                </div>

                                <div class="infra-card">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="REDIS"
                                               id="redisCheck" name="infrastructures">
                                        <label class="form-check-label" for="redisCheck">
                                            <div class="infra-icon text-danger">
                                                <i class="bi bi-lightning"></i>
                                            </div>
                                            <h5>Redis</h5>
                                            <small>인메모리 데이터 저장소</small>
                                        </label>
                                    </div>
                                </div>

                                <div class="infra-card">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="KAFKA"
                                               id="kafkaCheck" name="infrastructures">
                                        <label class="form-check-label" for="kafkaCheck">
                                            <div class="infra-icon text-warning">
                                                <i class="bi bi-arrow-left-right"></i>
                                            </div>
                                            <h5>Kafka</h5>
                                            <small>메시지 큐 시스템</small>
                                        </label>
                                    </div>
                                </div>

                                <!--                                <div class="infra-card">-->
                                <!--                                    <div class="form-check">-->
                                <!--                                        <input class="form-check-input" type="checkbox" value="ELASTICSEARCH"-->
                                <!--                                               id="elasticsearchCheck" name="infrastructures">-->
                                <!--                                        <label class="form-check-label" for="elasticsearchCheck">-->
                                <!--                                            <div class="infra-icon text-info">-->
                                <!--                                                <i class="bi bi-search"></i>-->
                                <!--                                            </div>-->
                                <!--                                            <h5>Elasticsearch</h5>-->
                                <!--                                            <small>검색 및 분석 엔진</small>-->
                                <!--                                        </label>-->
                                <!--                                    </div>-->
                                <!--                                </div>-->
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">인프라 시크릿 생성하기</button>
                        </div>
                    </form>

                    <div id="loading" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>인프라 시크릿 생성 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 시크릿 조회 탭 - 인프라 선택 기능 제거 -->
        <div class="tab-pane fade" id="search-tab-pane" role="tabpanel" aria-labelledby="search-tab" tabindex="0">
            <div class="card">
                <div class="card-header">
                    기존 시크릿 조회
                </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="mb-3">
                            <label for="searchEnvironment" class="form-label">환경 프로필</label>
                            <select class="form-select" id="searchEnvironment" name="searchEnvironment" required>
                                <option value="" selected disabled>환경을 선택하세요</option>
                                <option value="DEV" selected>개발 환경 (DEV)</option>
                                <!--                                <option value="PROD">운영 환경 (PROD)</option>-->
                            </select>
                            <div class="form-text">시크릿을 생성할 환경 프로필을 선택하세요.</div>
                        </div>

                        <div class="mb-4">
                            <label for="searchServiceName" class="form-label">서비스 이름</label>
                            <input type="text" class="form-control" id="searchServiceName" name="searchService" required
                                   placeholder="예: TEST, PAYMENT">
                            <div class="form-text">조회할 서비스의 이름을 입력하세요.</div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">시크릿 조회하기</button>
                        </div>
                    </form>

                    <div id="searchLoading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>시크릿 조회 중입니다...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultCard" class="card hidden">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>생성된 시크릿 JSON</span>
            <button id="copyButton" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-clipboard"></i> 복사
            </button>
        </div>
        <div class="card-body">
            <div class="json-output" id="jsonOutput"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('infraForm');
        const searchForm = document.getElementById('searchForm');
        const loading = document.getElementById('loading');
        const searchLoading = document.getElementById('searchLoading');
        const resultCard = document.getElementById('resultCard');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyButton = document.getElementById('copyButton');
        const notification = document.getElementById('copyNotification');

        // 탭 전환 시 결과 카드 숨기기
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function () {
                resultCard.classList.add('hidden');
            });
        });

        // 시크릿 생성 폼 제출 이벤트
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            // 체크박스가 하나도 선택되지 않았는지 확인
            const checkboxes = document.querySelectorAll('input[name="infrastructures"]:checked');
            if (checkboxes.length === 0) {
                alert('최소 하나 이상의 인프라스트럭처를 선택해주세요.');
                return;
            }

            const environment = document.getElementById('environment').value;

            // 서비스 이름 유효성 검사
            const serviceName = document.getElementById('applicationName').value;
            if (!/^[a-z0-9\-]+$/i.test(serviceName)) {
                alert('서비스 이름은 영문자, 숫자, 하이픈(-)만 포함할 수 있습니다.');
                return;
            }

            // 로딩 표시
            loading.style.display = 'block';
            form.style.display = 'none';

            // 선택된 인프라스트럭처 값 가져오기
            const selectedInfras = Array.from(checkboxes).map(cb => cb.value);

            // API 요청 데이터 생성
            const requestData = {
                resourceTypes: selectedInfras,
                service: serviceName,
                environment: environment
            };

            // API 호출 - 생성 API 먼저 호출 (상대 경로로 변경)
            fetch('/resource-configuration', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('시크릿 생성 API 요청 실패');
                    }
                    // 생성 성공 후, 조회 API 호출 - 상대 경로로 변경
                    return fetch(`/resource-configuration/properties/flat?service=${serviceName}&environment=${environment}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('시크릿 조회 API 요청 실패');
                    }
                    return response.json();
                })
                .then(data => {
                    // API 응답 처리 및 결과 표시
                    const formattedData = processApiResponse(data);
                    displayResult(formattedData, "생성된 시크릿 JSON");
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('시크릿 생성 또는 조회 중 오류가 발생했습니다: ' + error.message);
                })
                .finally(() => {
                    loading.style.display = 'none';
                    form.style.display = 'block';
                });
        });

        // 시크릿 조회 폼 제출 이벤트 - 인프라 선택 관련 부분 제거
        searchForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // 서비스 이름 가져오기
            const serviceName = document.getElementById('searchServiceName').value;
            if (!serviceName) {
                alert('서비스 이름을 입력해주세요.');
                return;
            }

            const environment = document.getElementById('searchEnvironment').value;

            // 로딩 표시
            searchLoading.style.display = 'block';
            searchForm.style.display = 'none';

            // 조회 API 호출 - 서비스 이름만 파라미터로 사용
            fetch(`/resource-configuration/properties/flat?service=${serviceName}&environment=${environment}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('시크릿 조회 API 요청 실패');
                    }
                    return response.json();
                })
                .then(data => {
                    // API 응답 처리 및 결과 표시
                    const formattedData = processApiResponse(data);
                    displayResult(formattedData, `'${serviceName}' 서비스의 시크릿 JSON`);
                })
                .catch(error => {
                    // console.error('Error:', error);
                    alert('시크릿 조회 중 오류가 발생했습니다: ' + error.message);
                })
                .finally(() => {
                    searchLoading.style.display = 'none';
                    searchForm.style.display = 'block';
                });
        });

        // API 응답 처리 함수
        function processApiResponse(apiResponse) {
            const result = {};

            // 각 리소스 설정을 반복하며 모든 정보 추출
            const config = apiResponse.properties;

            // 각 구성의 모든 키-값 쌍을 그대로 결과에 추가
            for (const [key, value] of Object.entries(config)) {
                // null이나 undefined가 아닌 값만 포함
                if (value !== null && value !== undefined) {
                    // 원래 키 이름 그대로 사용
                    result[key] = value;
                }
            }

            return result;
        }

        // 결과 표시 함수
        function displayResult(data, title) {
            // 제목 업데이트
            document.querySelector('#resultCard .card-header span').textContent = title;

            // JSON 데이터 표시
            jsonOutput.textContent = JSON.stringify(data, null, 2);
            resultCard.classList.remove('hidden');
            resultCard.scrollIntoView({behavior: 'smooth'});
        }

        // 복사 버튼 클릭 이벤트
        copyButton.addEventListener('click', function () {
            const textToCopy = jsonOutput.textContent;
            navigator.clipboard.writeText(textToCopy).then(() => {
                // 복사 성공 알림 표시
                notification.style.opacity = '1';
                setTimeout(() => {
                    notification.style.opacity = '0';
                }, 2000);
            }).catch(err => {
                console.error('복사 실패:', err);
                alert('클립보드 복사에 실패했습니다.');
            });
        });
    });
</script>
</body>
</html>